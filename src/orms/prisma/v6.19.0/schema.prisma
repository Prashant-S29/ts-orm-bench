// Prisma Schema - Version 6.19.0

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// USERS
model User {
    id           BigInt    @id @default(autoincrement())
    uuid         String    @unique @default(uuid()) @db.Uuid
    email        String    @unique @db.VarChar(255)
    username     String    @unique @db.VarChar(100)
    firstName    String    @map("first_name") @db.VarChar(100)
    lastName     String    @map("last_name") @db.VarChar(100)
    passwordHash String    @map("password_hash") @db.VarChar(255)
    isActive     Boolean   @default(true) @map("is_active")
    createdAt    DateTime  @default(now()) @map("created_at")
    updatedAt    DateTime  @updatedAt @map("updated_at")
    deletedAt    DateTime? @map("deleted_at")

    orders  Order[]
    reviews Review[]

    @@index([email])
    @@index([username])
    @@index([createdAt])
    @@index([isActive])
    @@map("users")
}

// CATEGORIES
model Category {
    id           BigInt   @id @default(autoincrement())
    name         String   @db.VarChar(100)
    slug         String   @unique @db.VarChar(100)
    description  String?  @db.Text
    parentId     BigInt?  @map("parent_id")
    displayOrder Int      @default(0) @map("display_order")
    isActive     Boolean  @default(true) @map("is_active")
    createdAt    DateTime @default(now()) @map("created_at")
    updatedAt    DateTime @updatedAt @map("updated_at")

    parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
    children Category[] @relation("CategoryHierarchy")
    products Product[]

    @@index([parentId])
    @@index([slug])
    @@index([isActive])
    @@map("categories")
}

// PRODUCTS
model Product {
    id             BigInt   @id @default(autoincrement())
    sku            String   @unique @db.VarChar(100)
    name           String   @db.VarChar(255)
    description    String?  @db.Text
    price          Decimal  @db.Decimal(10, 2)
    costPrice      Decimal? @map("cost_price") @db.Decimal(10, 2)
    categoryId     BigInt?  @map("category_id")
    inventoryCount Int      @default(0) @map("inventory_count")
    isActive       Boolean  @default(true) @map("is_active")
    weightGrams    Int?     @map("weight_grams")
    dimensionsJson Json?    @map("dimensions_json")
    createdAt      DateTime @default(now()) @map("created_at")
    updatedAt      DateTime @updatedAt @map("updated_at")

    category      Category?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
    orderItems    OrderItem[]
    reviews       Review[]
    productTags   ProductTag[]
    inventoryLogs InventoryLog[]

    @@index([sku])
    @@index([categoryId])
    @@index([price])
    @@index([isActive])
    @@index([inventoryCount])
    @@map("products")
}

// TAGS
model Tag {
    id         BigInt   @id @default(autoincrement())
    name       String   @unique @db.VarChar(50)
    slug       String   @unique @db.VarChar(50)
    usageCount Int      @default(0) @map("usage_count")
    createdAt  DateTime @default(now()) @map("created_at")

    productTags ProductTag[]

    @@index([slug])
    @@index([usageCount])
    @@map("tags")
}

// PRODUCT_TAGS (Junction Table)
model ProductTag {
    productId BigInt   @map("product_id")
    tagId     BigInt   @map("tag_id")
    createdAt DateTime @default(now()) @map("created_at")

    product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
    tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

    @@id([productId, tagId])
    @@index([tagId])
    @@map("product_tags")
}

// ORDERS
model Order {
    id                  BigInt    @id @default(autoincrement())
    orderNumber         String    @unique @map("order_number") @db.VarChar(50)
    userId              BigInt?   @map("user_id")
    status              String    @default("pending") @db.VarChar(50)
    totalAmount         Decimal   @map("total_amount") @db.Decimal(10, 2)
    shippingAddressJson Json      @map("shipping_address_json")
    billingAddressJson  Json      @map("billing_address_json")
    notes               String?   @db.Text
    createdAt           DateTime  @default(now()) @map("created_at")
    updatedAt           DateTime  @updatedAt @map("updated_at")
    shippedAt           DateTime? @map("shipped_at")
    deliveredAt         DateTime? @map("delivered_at")

    user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
    orderItems OrderItem[]

    @@index([userId])
    @@index([orderNumber])
    @@index([status])
    @@index([createdAt])
    @@map("orders")
}

// ORDER_ITEMS
model OrderItem {
    id                  BigInt   @id @default(autoincrement())
    orderId             BigInt   @map("order_id")
    productId           BigInt?  @map("product_id")
    productSnapshotJson Json     @map("product_snapshot_json")
    quantity            Int
    unitPrice           Decimal  @map("unit_price") @db.Decimal(10, 2)
    subtotal            Decimal  @db.Decimal(10, 2)
    createdAt           DateTime @default(now()) @map("created_at")

    order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
    product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

    @@index([orderId])
    @@index([productId])
    @@map("order_items")
}

// REVIEWS
model Review {
    id                 BigInt   @id @default(autoincrement())
    productId          BigInt   @map("product_id")
    userId             BigInt?  @map("user_id")
    rating             Int
    title              String?  @db.VarChar(200)
    comment            String?  @db.Text
    helpfulCount       Int      @default(0) @map("helpful_count")
    isVerifiedPurchase Boolean  @default(false) @map("is_verified_purchase")
    createdAt          DateTime @default(now()) @map("created_at")
    updatedAt          DateTime @updatedAt @map("updated_at")

    product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
    user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

    @@index([productId])
    @@index([userId])
    @@index([rating])
    @@index([createdAt])
    @@index([helpfulCount])
    @@map("reviews")
}

// INVENTORY_LOGS
model InventoryLog {
    id            BigInt   @id @default(autoincrement())
    productId     BigInt   @map("product_id")
    changeAmount  Int      @map("change_amount")
    reason        String   @db.VarChar(50)
    previousCount Int      @map("previous_count")
    newCount      Int      @map("new_count")
    notes         String?  @db.Text
    createdAt     DateTime @default(now()) @map("created_at")

    product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    @@index([productId])
    @@index([createdAt])
    @@index([reason])
    @@map("inventory_logs")
}
